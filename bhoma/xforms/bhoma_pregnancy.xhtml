<h:html xmlns="http://www.w3.org/2002/xforms"
        xmlns:h="http://www.w3.org/1999/xhtml"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:jr="http://openrosa.org/javarosa">
<h:head>
  <h:title>BHOMA Pregnancy Visit</h:title>
  <model>
		<instance>
			<pregnancy xmlns="http://cidrz.org/bhoma/pregnancy">
        
        <Meta>
            <clinic_id />
            <TimeStart />
            <TimeEnd />
            <username />
            <user_id />
            <uid />
        </Meta>
        
        <case>
            <patient_id></patient_id> <!-- preloaded -->
            <case_type></case_type> <!-- diagnosis -->
            <followup_type></followup_type> <!-- referral, chw followup, facility followup, closed -->
            <followup_date></followup_date> <!-- generated by form or empty (in days) -->
            <outcome></outcome> <!-- how the case was closed -->
        </case>
        
        
        <!-- pre-loaded patient info from patient select module -->
				
        <encounter_date />
        <visit_number />
        <first_visit>
          <num_pregs />
          <num_births />
          <num_children />
          <height />
          <past_complications />
          <past_caesarian />
          <lmp />
          <edd />
        </first_visit>        
        <gestational_age />
        <blood_pressure />
        <fundal_height />
        <presentation />
        <fetal_heart_rate />
        <weight />
        <urinalysis />
        <hgb />
        <danger_signs />
		<hiv_first_visit>
			<hiv />
			<partner_hiv />
		</hiv_first_visit>
		<hiv_after_first_visit>
			<hiv />
			<partner_hiv />
		</hiv_after_first_visit>
        <cd4 />
        <on_haart />
        <pmtct />
        <rpr />
        <checklist />
        <next_visit />

        <resolution />
        <outcome />
			</pregnancy>
		</instance>

    <bind nodeset="Meta/clinic_id" jr:preload="meta" jr:preloadParams="clinic_id" />
    <bind nodeset="Meta/username" jr:preload="meta" jr:preloadParams="username" />
    <bind nodeset="Meta/user_id" jr:preload="meta" jr:preloadParams="user_id" />
    <bind nodeset="Meta/TimeStart" type="dateTime" jr:preload="timestamp" jr:preloadParams="start" />
    <bind nodeset="Meta/TimeEnd" type="dateTime" jr:preload="timestamp" jr:preloadParams="end" />
    <bind nodeset="Meta/uid" type="xsd:string" jr:preload="uid" jr:preloadParams="general" />
    		
    <bind nodeset="case/patient_id" type="xsd:string" jr:preload="case" jr:preloadParams="patient_id" />
    <bind nodeset="case/case_type" type="xsd:string" /> <!-- TODO: calculate -->
    <bind nodeset="case/followup_type" type="xsd:string" calculate="../../resolution"/>
    <bind nodeset="case/followup_date" type="int" /> <!-- TODO: calculate -->
    <bind nodeset="case/outcome" type="int" calculate="../../outcome"/>
    
    <bind nodeset="encounter_date" type="date" required="true()" jr:preload="date" jr:preloadParams="today" constraint=". &lt;= today() + 1 and . &gt;= today() - 30" jr:constraintMsg="Must be within recent past" />
    <bind nodeset="visit_number" required="true()" />
    <bind nodeset="first_visit" relevant="../visit_number = '1'" />
    <bind nodeset="first_visit/num_pregs" type="int" constraint=". &lt; 30" jr:constraintMsg="Enter a value less than 30" />
    <bind nodeset="first_visit/num_births" type="int" relevant="../num_pregs &gt; 0" constraint=". &lt; 30" jr:constraintMsg="Enter a value less than 30" />
    <bind nodeset="first_visit/num_children" type="int" relevant="../num_pregs &gt; 0" constraint=". &lt; 30" jr:constraintMsg="Enter a value less than 30" />
    <bind nodeset="first_visit/past_complications" relevant="../num_pregs &gt; 0" />
    <bind nodeset="first_visit/past_caesarian" relevant="../num_pregs &gt; 0" />
    <bind nodeset="first_visit/height" type="int" constraint=". &gt;= 25 and . &lt;= 250" jr:constraintMsg="Height should be between 25 cm and 250 cm" /> <!-- soft constraint? -->
    <bind nodeset="first_visit/lmp" type="date" constraint=". &lt; today() + 5 and . &gt; today() - 180" jr:constraintMsg="LMP Date should be within last 180 days"/>
    <bind nodeset="first_visit/edd" type="date" constraint=". &lt; today() + 365 and . &gt; today() - 90" jr:constraintMsg="EDD Date not possible"/>
    <bind nodeset="gestational_age" type="int" constraint=". &lt; 45" jr:constraintMsg="Gestation Age should be less than 45 weeks"/>
    <bind nodeset="blood_pressure" type="string" constraint="true()" />
    <bind nodeset="fundal_height" type="int" constraint=". &lt; 50" jr:constraintMsg="Fundal Height should be less than 50 cm"/>
    <bind nodeset="fetal_heart_rate" type="int" constraint=". &lt; 300" jr:constraintMsg="Fetal Heart Rate should be less than 300"/>
    <bind nodeset="weight" type="decimal" constraint=". &lt;= 250" jr:constraintMsg="Weight should be less than 250 kg"/>
    <bind nodeset="hgb" type="int" constraint=". &lt;= 25" jr:constraintMsg="Hgb should be less than 25 (g/dL)" />
	<bind nodeset="danger_signs" required="true()" constraint="not(selected(., 'none') and count-selected(.) &gt; 1)" jr:constraintMsg="Cant select 'None' and another answer" />
	<bind nodeset="hiv_first_visit" relevant="../visit_number = '1'" />
	<bind nodeset="hiv_after_first_visit" relevant="../visit_number &gt; '1'" />
    <bind nodeset="cd4" type="int" constraint=". &lt;= 3000" jr:constraintMsg="CD4 count should be less than 3000 (cells/mm3)" />
    <bind nodeset="next_visit" type="date" constraint=". &gt; today() - 30" jr:constraintMsg="Next visit should be within about 30 days"/>
	<bind nodeset="resolution" required="true()" />
    <bind nodeset="outcome" relevant="../resolution = 'y'" />

	</model>
</h:head>			
<h:body>

  <input ref="encounter_date">
    <label>Enter Visit Date</label>
  </input>
	
  <select1 ref="visit_number">
    <label>Which # Visit is This?</label>
    <item><label>First</label><value>1</value></item>
    <item><label>Second</label><value>2</value></item>
    <item><label>Third</label><value>3</value></item>
    <item><label>Fourth</label><value>4</value></item>
    <item><label>Fifth</label><value>5</value></item>
    <item><label>Sixth</label><value>6</value></item>
	<item><label>Unscheduled Sick Visit</label><value>sick</value></item>
    <item><label>Other</label><value>other</value></item>
	<hint> Please select the appropriate visit number </hint>
  </select1>

  <input ref="first_visit/num_pregs">
    <label>Enter Number of Previous Pregnancies</label>
	
  </input>

  <input ref="first_visit/num_births">
    <label>Enter Number of Previous Live Births</label>
	<hint> Enter all previous live births </hint>
  </input>

  <input ref="first_visit/num_children">
    <label>Enter Number of Living Children</label>
  </input>

  <input ref="first_visit/height">
    <label>Enter Patient Height (cm)</label>
	<hint> This is Height measured in Centimeters </hint>
  </input>

  <select1 ref="first_visit/past_complications">
    <label>Have Any Past Pregnancies had Complications?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <select1 ref="first_visit/past_caesarian">
    <label>Were any of the past deliveries by Caesarian?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <input ref="first_visit/lmp">
    <label>Enter Last Menstrual Period</label>
	<hint> The LMP is the date of onset of the last menstrual period. Record the patient's LMP in the format of Day / Month/ Year </hint>
  </input>

  <input ref="first_visit/edd">
    <label>Enter Expected Delivery Date</label>
	
  </input>

  <input ref="gestational_age">
    <label>Enter Gestational Age (weeks)</label>
	
  </input>

  <input ref="blood_pressure" appearance="domain: bp;">
    <label>Enter Blood Pressure (___ /___) </label>
	<hint> Blood pressure should be recorded on the form as systolic pressure over diastolic pressure. </hint>
  </input>

  <input ref="fundal_height">
    <label>Enter Fundal Height (cm)</label>
	<hint> Record the fundal height in centimeters.</hint>
  </input>

  <select1 ref="presentation">
    <label>Select Presentation</label>
    <item><label>Breech</label><value>breech</value></item>
    <item><label>Cephalic</label><value>cephalic</value></item>
	
  </select1>

  <input ref="fetal_heart_rate">
    <label>Enter Fetal Heart Rate (per minute)</label>
	<hint> Record the fetal heart rate in beats per minute.</hint>
  </input>

  <input ref="weight">
    <label>Enter Patient Weight (kg)</label>
	<hint> Enter weight in Kilograms</hint>
  </input>

  <select1 ref="urinalysis">
    <label>Select Urinalysis Result</label>
    <item><label>Protein Positive</label><value>protein_pos</value></item>
    <item><label>Not Protein Positive</label><value>.</value></item>
  </select1>

  <input ref="hgb">
    <label>Enter Hgb Amount (g/dL)</label>
	<hint> Enter the Hgb Amount</hint>
  </input>

  <select ref="danger_signs">
    <label>Select Any Danger Signs Present</label>
    <item><label>Vaginal bleeding</label><value>bleeding</value></item>    
    <item><label>Draining</label><value>draining</value></item>    
    <item><label>Contractions</label><value>contract</value></item>    
    <item><label>Pain urinating</label><value>pain_urinating</value></item>    
    <item><label>Pelvic pressure</label><value>pelvic_pressure</value></item>    
    <item><label>Oedema</label><value>oedema</value></item>
	<item><label>None</label><value>none</value></item>
	<hint> Select all danger signs that the patient is presenting</hint>
  </select>

  <select1 ref="hiv_first_visit/hiv">
    <label>Select Result of HIV Test</label>
    <item><label>Previously Reactive</label><value>prev_r</value></item>
    <item><label>Reactive</label><value>r</value></item>
    <item><label>Not Reactive</label><value>nr</value></item>
  </select1>

  <select1 ref="hiv_first_visit/partner_hiv">
    <label>Select Result of Partner HIV Test</label>
    <item><label>Previously Reactive</label><value>prev_r</value></item>
    <item><label>Reactive</label><value>r</value></item>
    <item><label>Not Reactive</label><value>nr</value></item>
  </select1>
  
  <select1 ref="hiv_after_first_visit/hiv">
    <label>Select Result of HIV Test</label>
    <item><label>Reactive</label><value>r</value></item>
    <item><label>Not Reactive</label><value>nr</value></item>
    <item><label>Not Done</label><value>nd</value></item>
  </select1>

  <select1 ref="hiv_after_first_visit/partner_hiv">
    <label>Select Result of Partner HIV Test</label>
    <item><label>Reactive</label><value>r</value></item>
    <item><label>Not Reactive</label><value>nr</value></item>
    <item><label>Not Done</label><value>nd</value></item>
  </select1>

  <input ref="cd4">
    <label>Enter CD4 Count (cells / mm3)</label>
  </input>

  <select1 ref="on_haart">
    <label>Is the Patient on HAART?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <select ref="pmtct">
    <label>Which PMTCT Medicine is the Patient Taking?</label>
    <item><label>AZT</label><value>azt</value></item>
    <item><label>NVP</label><value>nvp</value></item>
  </select>

  <select1 ref="rpr">
    <label>Select Result of RPR Test</label>
    <item><label>R</label><value>r</value></item>
    <item><label>NR</label><value>nr</value></item>
  </select1>

  <select ref="checklist">
    <label>Tick All Items That Apply to This Patient</label>
    <item><label>Penicillin</label><value>penicillin</value></item>
    <item><label>Partner Penicillin</label><value>partner_penicillin</value></item>
    <item><label>TT</label><value>tt</value></item>
    <item><label>Fansidar</label><value>fansidar</value></item>
    <item><label>Mebendazole</label><value>mebendazole</value></item>
    <item><label>Iron/Folate</label><value>iron_folate</value></item>
    <item><label>Sleeps under Insect-treated Net</label><value>bednet</value></item>
    <item><label>FP/IF counselling</label><value>fp_if_counselling</value></item>
  </select>

  <input ref="next_visit">
    <label>Next visit scheduled for...</label>
	
  </input>
  
  <select1 ref="resolution">
    <label>Has this pregnancy case been closed?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <select1 ref="outcome">
    <label>Select Outcome to Case</label>
    <item><label>Uncomplicated antepartum course</label><value>uncomplicated_antepartum_course</value></item>
    <item><label>Uncomplicated antepartum course up to 38 weeks</label><value>uncomplicated_antepartum_course_38_weeks</value></item>
    <item><label>Ectopic Pregnancy Treated</label><value>ectopic_pregnancy_treated</value></item>
    <item><label>Abortion Managed</label><value>abortion_managed</value></item>
    <item><label>Pre-term Labor Managed</label><value>preterm_labor_managed</value></item>
    <item><label>Antepartum Hemorrhage Treated</label><value>antepartum_hemorrhage_treated</value></item>
    <item><label>Antepartum Infection Managed</label><value>antepartum_infection_managed</value></item>
    <item><label>Antepartum (pre-) Eclampsia Managed</label><value>antepartum_eclampsia_managed</value></item>
    <item><label>Maternal Death, Baby Alive</label><value>maternal_death_baby_alive</value></item>
    <item><label>Fetal Death, Mother Alive</label><value>fetal_death_mother_alive</value></item>
    <item><label>Maternal and Fetal Death</label><value>maternal_and_fetal_death</value></item>
    <item><label>Diarrhea/Dehydration Treated</label><value>diarrhea_treated</value></item>
    <item><label>Malaria Treated</label><value>malaria_treated</value></item>
    <item><label>Unknown</label><value>unknown</value></item>
    <item><label>Other</label><value>other</value></item>
  </select1>

</h:body>
</h:html>
