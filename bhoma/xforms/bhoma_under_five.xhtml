<h:html xmlns="http://www.w3.org/2002/xforms"
        xmlns:h="http://www.w3.org/1999/xhtml"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:jr="http://openrosa.org/javarosa">
<h:head>
  <h:title>BHOMA Under-Five Visit</h:title>
  <model>
		<instance>
			<underfive xmlns="http://cidrz.org/bhoma/underfive">
        <!-- insert meta block -->
        <!-- insert casexml block -->
        <!-- pre-loaded patient info from patient select module, including... -->
            <age />				

        <encounter_date />
        <encounter_type />
        <chw_referral_id />
        <vitals>
          <height />
          <weight />
          <head_circumference />
          <temp />
          <resp_rate />
          <heart_rate />
        </vitals>
        <danger_signs />
        <hiv>
          <status />
          <pcr_result />
          <pcr_date />
          <antibody_result />
        </hiv>
        <missing_immunizations />
        <nutrition>
          <weight_for_age />
          <feeding />
          <growing_normally />
        </nutrition>
        <general_exam />
        <phys_exam_detail />
        <assessment>
          <categories />
          <resp />
          <diarrhea />
          <fever />
          <ear />
          <malnutrition />
        </assessment>
        <investigations>
          <categories />
          <rdt_mps />
          <hiv_rapid />
          <pcr />
          <cd4 />
          <wbc />
          <rbc />
          <hb />
          <platelets />
          <urine />
          <stool />
          <cxr />
          <rpr />
          <sputum />
        </investigations>
        <diagnosis />
        <drugs>
          <prescribed>
            <med jr:template="">
              <drug />
              <dosage />
              <freq />
              <duration />
            </med>
          </prescribed>
          <dispensed_as_prescribed />
          <dispensed>
            <med>
              <drug />
              <dosage />
              <freq />
              <duration />
            </med>
          </dispensed>
        </drugs>
        <resolution />
        <followup_days />
        <outcome />

			</underfive>
		</instance>
		
    <bind nodeset="encounter_date" type="date" required="true()" jr:preload="date" jr:preloadParams="today" constraint=". &lt;= today() + 1 and . &gt;= today() - 30" jr:constraintMsg="Must be within recent past" />
    <bind nodeset="encounter_type" required="true()" />
    <bind nodeset="chw_referral_id" type="int" relevant="../encounter_type = 'new_case'" />
    <bind nodeset="vitals/height" type="int" constraint=". &gt;= 25 and . &lt;= 250" jr:constraintMsg="Value outside of allowed range" /> <!-- soft constraint? -->
    <bind nodeset="vitals/weight" type="decimal" constraint=". &lt;= 250" jr:constraintMsg="Value outside of allowed range" /> <!-- soft constraint? -->
    <bind nodeset="vitals/head_circumference" type="int" relevant="../../age &lt; 2" constraint="true()" jr:constraintMsg="Value outside of allowed range" /> <!-- soft constraint? -->
    <bind nodeset="vitals/temp" type="decimal" constraint=". &gt;= 30 and . &lt;= 45" jr:constraintMsg="Value outside of allowed range" /> <!-- soft constraint? -->
    <bind nodeset="vitals/resp_rate" type="int" constraint="true()" jr:constraintMsg="Value outside of allowed range" /> <!-- soft constraint? -->
    <bind nodeset="vitals/heart_rate" type="int" constraint="true()" jr:constraintMsg="Value outside of allowed range" /> <!-- soft constraint? -->
    <bind nodeset="hiv/pcr_date" type="date" constraint=". &lt;= today()" jr:constraintMsg="Cannot be in future" relevant="../pcr_result != 'nd'" />
    <bind nodeset="assessment/resp" relevant="selected(../categories, 'resp')" />
    <bind nodeset="assessment/diarrhea" relevant="selected(../categories, 'diarrhea')" />
    <bind nodeset="assessment/fever" relevant="selected(../categories, 'fever')" />
    <bind nodeset="assessment/ear" relevant="selected(../categories, 'ear')" />
    <bind nodeset="assessment/malnutrition" relevant="selected(../categories, 'malnutrition')" />
    <bind nodeset="investigations/rdt_mps" relevant="selected(../categories, 'rdt_mps')" />
    <bind nodeset="investigations/hiv_rapid" relevant="selected(../categories, 'hiv_rapid')" />
    <bind nodeset="investigations/pcr" relevant="selected(../categories, 'pcr')" />
    <bind nodeset="investigations/cd4" type="decimal" relevant="selected(../categories, 'cd4')" />
    <bind nodeset="investigations/wbc" type="decimal" relevant="selected(../categories, 'wbc_rbc')" />
    <bind nodeset="investigations/rbc" type="decimal" relevant="selected(../categories, 'wbc_rbc')" />
    <bind nodeset="investigations/hb" type="decimal" relevant="selected(../categories, 'hb_plat')" />
    <bind nodeset="investigations/platelets" type="decimal" relevant="selected(../categories, 'hb_plat')" />
    <bind nodeset="investigations/urine" relevant="selected(../categories, 'urine')" />
    <bind nodeset="investigations/stool" relevant="selected(../categories, 'stool')" />
    <bind nodeset="investigations/cxr" relevant="selected(../categories, 'cxr')" />
    <bind nodeset="investigations/rpr" relevant="selected(../categories, 'rpr')" />
    <bind nodeset="investigations/sputum" relevant="selected(../categories, 'sputum')" />
    <bind nodeset="drugs/prescribed/med/drug" required="true()" /> <!-- make select? -->
    <bind nodeset="drugs/prescribed/med/dosage" type="int" required="true()" /> <!-- make select? -->
    <bind nodeset="drugs/prescribed/med/freq" type="int" required="true()" /> <!-- make select? -->
    <bind nodeset="drugs/prescribed/med/duration" type="int" required="true()" /> <!-- make select? -->
    <bind nodeset="drugs/dispensed_as_prescribed" relevant="count(../prescribed/med) &gt; 0" />
    <bind nodeset="drugs/dispensed/med" relevant="../../dispensed_as_prescribed = 'n'" />
    <bind nodeset="drugs/dispensed/med/drug" required="true()" /> <!-- make select? -->
    <bind nodeset="drugs/dispensed/med/dosage" type="int" required="true()" /> <!-- make select? -->
    <bind nodeset="drugs/dispensed/med/freq" type="int" required="true()" /> <!-- make select? -->
    <bind nodeset="drugs/dispensed/med/duration" type="int" required="true()" /> <!-- make select? -->
    <bind nodeset="resolution" required="true()" />
    <bind nodeset="followup_days" type="int" relevant="../resolution = 'followup-clinic' or ../resolution = 'followup-chw'" />    
    <bind nodeset="outcome" relevant="../resolution = 'closed'" />

	</model>
</h:head>			
<h:body>

  <input ref="encounter_date">
    <label>Date</label>
  </input>
	
  <select1 ref="encounter_type">
    <label>First Encounter?</label>
    <item><label>New Case</label><value>new_case</value></item>
    <item><label>Review</label><value>review</value></item>
  </select1>

  <input ref="chw_referral_id">
    <label>CHW Referral # (if applicable)</label>
  </input>

  <input ref="vitals/height">
    <label>Height (cm)</label>
  </input>
	
  <input ref="vitals/weight">
    <label>Weight (kg)</label>
  </input>
	
  <input ref="vitals/head_circumference">
    <label>Head Circumference</label>
  </input>
	
  <input ref="vitals/temp">
    <label>Temperature (*C)</label>
  </input>
	
  <input ref="vitals/resp_rate">
    <label>Respiratory Rate (per minute)</label>
  </input>
	
  <input ref="vitals/heart_rate">
    <label>Heart Rate (per minute)</label>
  </input>
	
  <select ref="danger_signs">
    <label>Danger signs present</label>
    <item><label>Cannot drink/breastfeed</label><value>nodrink</value></item>
    <item><label>Vomits everything</label><value>vomits</value></item>
    <item><label>Convulsions</label><value>convuls</value></item>
    <item><label>Lethargic / Unconscious</label><value>lethargic</value></item>
  </select>

  <select1 ref="hiv/status">
    <label>HIV exposure from Under-5 card</label>
    <item><label>Exposed</label><value>exp</value></item>
    <item><label>Not exposed</label><value>unexp</value></item>
    <item><label>Unknown</label><value>unk</value></item>
  </select1>

  <select1 ref="hiv/pcr_result">
    <label>PCR at 6 weeks</label>
    <item><label>Reactive</label><value>r</value></item>
    <item><label>Not Reactive</label><value>nr</value></item>
    <item><label>Not Done</label><value>nd</value></item>
  </select1>

  <input ref="hiv/pcr_date">
    <label>PCR Collection Date</label>
  </input>

  <select1 ref="hiv/antibody_result">
    <label>Antibody test at 18 months</label>
    <item><label>Reactive</label><value>r</value></item>
    <item><label>Not Reactive</label><value>nr</value></item>
    <item><label>Not Done</label><value>nd</value></item>
  </select1>

  <select ref="missing_immunizations">
    <label>Missing Immunizations</label>
    <item><label>&lt;= 6 weeks: BCG</label><value>bcg</value></item>
    <item><label>&lt;= 6 weeks: OPV 0</label><value>opv_0</value></item>
    <item><label>&lt;= 6 weeks: OPV 1</label><value>opv_1</value></item>
    <item><label>&lt;= 6 weeks: DPT/HepB/Hib 1</label><value>dpt_hepb_hib_1</value></item>
    <item><label>&lt;= 6 months: OPV 2</label><value>opv_2</value></item>
    <item><label>&lt;= 6 months: OPV 3</label><value>opv_3</value></item>
    <item><label>&lt;= 6 months: DPT/HepB/Hib 2</label><value>dpt_hepb_hib_2</value></item>
    <item><label>&lt;= 6 months: DPT/HepB/Hib 3</label><value>dpt_hepb_hib_3</value></item>
    <item><label>&gt;= 9 months: OPV 4</label><value>opv_4</value></item>
    <item><label>&gt;= 9 months: Measles</label><value>measles</value></item>
  </select>

  <select1 ref="nutrition/weight_for_age">
    <label>Weight for age</label>
    <item><label>&gt; 0</label><value>0</value></item>
    <item><label>0 to -2</label><value>-2</value></item>
    <item><label>-2 to -3</label><value>-3</value></item>
    <item><label>&lt; -3</label><value>below_-3</value></item>
  </select1>

  <select1 ref="nutrition/feeding">
    <label>Current feeding method</label>
    <item><label>Exclusive breastfeeding</label><value>breast_only</value></item>
    <item><label>Mixed feeding</label><value>mixed</value></item>
    <item><label>Replacement feeding</label><value>replacement</value></item>
  </select1>

  <select1 ref="nutrition/growing_normally">
    <label>Does mother think child is growing normally?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <select ref="general_exam">
    <label>Physical Exam -- General</label>
    <item><label>Severe Pallor</label><value>severe_pallor</value></item>
    <item><label>Moderate Pallor</label><value>mod_pallor</value></item>
    <item><label>Jaundice</label><value>jaundice</value></item>
    <item><label>Oedema</label><value>oedema</value></item>
  </select>

  <select ref="phys_exam_detail">
    <label>Physical Exam -- Abnormal Findings for...</label>
    <item><label>Skin</label><value>skin</value></item>
    <item><label>Eyes</label><value>eyes</value></item>
    <item><label>Ears, Nose</label><value>ears_nose</value></item>
    <item><label>Throat / Oral</label><value>throat_oral</value></item>
    <item><label>Lymph nodes</label><value>lymph</value></item>
    <item><label>Anterior fontanel</label><value>fontanel</value></item>
    <item><label>Chest / Lungs</label><value>chest_lungs</value></item>
    <item><label>Abdomen</label><value>abdomen</value></item>
    <item><label>Neurological</label><value>neuro</value></item>
  </select>

  <select ref="assessment/categories">
    <label>Patient's assessment</label>
    <item><label>Cough / Difficulty breathing</label><value>resp</value></item>
    <item><label>Diarrhea</label><value>diarrhea</value></item>
    <item><label>Fever</label><value>fever</value></item>
    <item><label>Ear problem</label><value>ear</value></item>
    <item><label>Malnutrition / low weight</label><value>malnutrition</value></item>
    <item><label>Other</label><value>other</value></item>
  </select>

  <select ref="assessment/resp">
    <label>Assessment: Cough/Difficulty Breathing</label>
    <item><label>SEVERE: stridor</label><value>1</value></item>
    <item><label>SEVERE: indrawing</label><value>2</value></item>
    <item><label>MODERATE: fast breathing</label><value>3</value></item>
    <item><label>MILD: no sign of severe disease or pneumonia</label><value>4</value></item>
  </select>

  <select ref="assessment/diarrhea">
    <label>Assessment: Diarrhea</label>
    <item><label>SEVERE: severe dehydration / not responding to oral rehydration</label><value>1</value></item>
    <item><label>SEVERE: &gt; 14 days</label><value>2</value></item>
    <item><label>MODERATE: moderate dehydration</label><value>3</value></item>
    <item><label>MODERATE: &gt; 14 days</label><value>4</value></item>
    <item><label>MILD: no dehyrdation</label><value>5</value></item>
    <item><label>MILD: &gt; 14 days</label><value>6</value></item>
  </select>

  <select ref="assessment/fever">
    <label>Assessment: Fever</label>
    <item><label>SEVERE: &gt; 7 days, every day</label><value>1</value></item>
    <item><label>SEVERE: stiff neck, bulging fontanel</label><value>2</value></item>
    <item><label>MODERATE: malaria (RDT-positive)</label><value>3</value></item>
    <item><label>MILD: runny nose or other cause</label><value>4</value></item>
  </select>

  <select ref="assessment/ear">
    <label>Assessment: Ear problem</label>
    <item><label>SEVERE: tender swelling behind ear</label><value>1</value></item>
    <item><label>MODERATE: pus &lt; 14 days or pain</label><value>2</value></item>
    <item><label>MILD: pus &gt; 14 days</label><value>3</value></item>
    <item><label>MILD: foreign body</label><value>4</value></item>
  </select>

  <select ref="assessment/malnutrition">
    <label>Assessment: Malnutrition / low weight</label>
    <item><label>SEVERE: &lt; -3 SD</label><value>1</value></item>
    <item><label>SEVERE: oedema+++</label><value>2</value></item>
    <item><label>MODERATE: -2 to -3 SD</label><value>3</value></item>
    <item><label>MODERATE: oedema++</label><value>4</value></item>
    <item><label>MILD: 0 to -2 SD</label><value>5</value></item>
  </select>

  <select ref="investigations/categories">
    <label>Investigations Performed</label>
    <item><label>RDT/MPS</label><value>rdt_mps</value></item>
    <item><label>HIV rapid</label><value>hiv_rapid</value></item>
    <item><label>HIV DNA PCR</label><value>pcr</value></item>
    <item><label>CD4</label><value>cd4</value></item>
    <item><label>WBC/RBC</label><value>wbc_rbc</value></item>
    <item><label>HB/Platelets</label><value>hb_plat</value></item>
    <item><label>Urine</label><value>urine</value></item>
    <item><label>Stool</label><value>stool</value></item>
    <item><label>CXR</label><value>cxr</value></item>
    <item><label>RPR</label><value>rpr</value></item>
    <item><label>Sputum</label><value>sputum</value></item>
    <item><label>Other</label><value>other</value></item>
  </select>

  <select1 ref="investigations/rdt_mps">
    <label>Result: RDT/MPS</label>
    <item><label>Negative</label><value>n</value></item>
    <item><label>Positive</label><value>p</value></item>
    <item><label>Not done</label><value>.</value></item>
  </select1>

  <select1 ref="investigations/hiv_rapid">
    <label>Result: HIV rapid</label>
    <item><label>Reactive</label><value>r</value></item>
    <item><label>Not reactive</label><value>nr</value></item>
    <item><label>Not done</label><value>.</value></item>
  </select1>

  <select1 ref="investigations/pcr">
    <label>Result: HIV DNA PCR</label>
    <item><label>Reactive</label><value>r</value></item>
    <item><label>Not reactive</label><value>nr</value></item>
    <item><label>Not done</label><value>.</value></item>
  </select1>

  <input ref="investigations/cd4">
    <label>Result: CD4 (cells / mm3)</label>
  </input>

  <input ref="investigations/wbc">
    <label>Result: WBC (cells / L)</label>
  </input>

  <input ref="investigations/rbc">
    <label>Result: RBC (cells / L)</label>
  </input>

  <input ref="investigations/hb">
    <label>Result: HB (gm / dL)</label>
  </input>

  <input ref="investigations/platelets">
    <label>Result: Platelets (cmm)</label>
  </input>

  <select1 ref="investigations/urine">
    <label>Result: Urine</label>
    <item><label>Blood</label><value>blood</value></item>
    <item><label>Glucose</label><value>glucose</value></item>
    <item><label>Protein</label><value>protein</value></item>
    <item><label>White cells</label><value>whitecells</value></item>
  </select1>

  <select1 ref="investigations/stool">
    <label>Result: Stool</label>
    <item><label>Blood</label><value>blood</value></item>
    <item><label>Pus</label><value>pus</value></item>
    <item><label>Parasite/Bacteria</label><value>parasite_bacteria</value></item>
  </select1>

  <select1 ref="investigations/cxr">
    <label>Result: CXR</label>
    <item><label>Normal</label><value>norm</value></item>
    <item><label>Abnormal</label><value>abn</value></item>
    <item><label>Heart condition</label><value>heart</value></item>
  </select1>

  <select1 ref="investigations/rpr">
    <label>Result: RPR</label>
    <item><label>Reactive</label><value>r</value></item>
    <item><label>Not reactive</label><value>nr</value></item>
    <item><label>Not done</label><value>.</value></item>
  </select1>

  <select1 ref="investigations/sputum">
    <label>Result: Sputum</label>
    <item><label>AAFB</label><value>aafb</value></item>
    <item><label>S</label><value>s</value></item>
    <item><label>NS</label><value>ns</value></item>
  </select1>

  <select1 ref="diagnosis">
    <label>Diagnosis</label>
    <item><label>Malaria</label><value>malaria</value></item>
    <item><label>RTI</label><value>rti</value></item>
    <item><label>Diarrhea</label><value>diarrhea</value></item>
    <item><label>UTI</label><value>uti</value></item>
    <item><label>Dehydration</label><value>dehydration</value></item>
    <item><label>Anaemia</label><value>anemia</value></item>
    <item><label>Infection</label><value>infection</value></item>
    <item><label>Malnutrition</label><value>malnutrition</value></item>
    <item><label>TB</label><value>tb</value></item>
    <item><label>Injury</label><value>injury</value></item>
    <item><label>Low weight for age</label><value>low_weight</value></item>
    <item><label>Meningitis</label><value>meningitis</value></item>
    <item><label>Other</label><value>other</value></item>
  </select1>

  <group>
  <label>Prescribed Drug</label>
  <repeat nodeset="drugs/prescribed/med">

    <select1 ref="drug">
      <label>Drug (as prescribed)</label>
      <item><label>Amoxycillin</label><value>A</value></item>
      <item><label>Benzodiazeprine</label><value>B</value></item>
      <item><label>Cotrimoxazole</label><value>C</value></item>
      <item><label>Other</label><value>other</value></item>
    </select1>
    
    <input ref="dosage">
      <label>Dosage (mg)</label>
    </input>

    <input ref="freq">
      <label>How many times a day?</label>
    </input>

    <input ref="duration">
      <label>For how many days?</label>
    </input>

  </repeat>
  </group>

  <select1 ref="drugs/dispensed_as_prescribed">
    <label>Was original prescription dispensed?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <group>
  <label>Dispensed Drug</label>
  <repeat nodeset="drugs/dispensed/med">

    <select1 ref="drug">
      <label>Drug (as dispensed)</label>
      <item><label>Amoxycillin</label><value>A</value></item>
      <item><label>Benzodiazeprine</label><value>B</value></item>
      <item><label>Cotrimoxazole</label><value>C</value></item>
      <item><label>Other</label><value>other</value></item>
    </select1>
    
    <input ref="dosage">
      <label>Dosage (mg)</label>
    </input>

    <input ref="freq">
      <label>How many times a day?</label>
    </input>

    <input ref="duration">
      <label>For how many days?</label>
    </input>

  </repeat>
  </group>

  <select1 ref="resolution">
    <label>How was this encounter resolved?</label>
    <item><label>Patient referred to hospital/specialist</label><value>referral</value></item>
    <item><label>Patient will return to health center</label><value>followup-clinic</value></item>
    <item><label>CHW will follow up with patient</label><value>followup-chw</value></item>
    <item><label>Case closed in clinic</label><value>closed</value></item>
  </select1>

  <input ref="followup_days">
    <label>Follow up in how many days?</label>
  </input>

  <select1 ref="outcome">
    <label>Case closed outcome</label>
    <item><label>Dehydration treated/resolved</label><value>1</value></item>
    <item><label>Severe malnutrition treated/resolved</label><value>2</value></item>
    <item><label>Low weight for age treated/resolved</label><value>3</value></item>
    <item><label>Meningitis treated/resolved</label><value>4</value></item>
    <item><label>Malaria treated/resolved</label><value>5</value></item>
    <item><label>Other fever/infection treated/resolved</label><value>6</value></item>
    <item><label>Diarrhea treated/resolved</label><value>9</value></item>
    <item><label>Pneumonia treated/resolved</label><value>10</value></item>
    <item><label>Upper RTI treated/resolved</label><value>11</value></item>
    <item><label>Death</label><value>7</value></item>
    <item><label>Unknown</label><value>8</value></item>
    <item><label>Other</label><value>13</value></item>
  </select1>

</h:body>
</h:html>
