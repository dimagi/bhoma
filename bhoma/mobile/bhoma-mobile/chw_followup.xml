<h:html xmlns="http://www.w3.org/2002/xforms"
        xmlns:h="http://www.w3.org/1999/xhtml"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:jr="http://openrosa.org/javarosa">
<h:head>
  <h:title>CHW Follow-up</h:title>
  <model>
	<instance>
	  <chw_fu xmlns="http://cidrz.org/bhoma/chw_followup">
        
        <Meta>
            <DeviceID />
            <TimeStart />
            <TimeEnd />
            <username />
            <user_id />
            <uid />
        </Meta>
        
        <case>
        	<!-- stuff here -->
        </case>

		<case_info>
		
		</case_info>

		<date />
		<info_be_on_time />
		<met_with_patient />
		<met>
		
		
		</met>
		<no_meet>
		  <why_not />
		  <unresolved>
		    <still_open>
		      <attempt_again />
		      <again>
		        <info />
		        <when />
		      </again>
		    </still_open>
		    <info_lost_to_followup />
		  </unresolved>
		</no_meet>

        <tmp>
          <why_not_nohosp />
		  <why_not_hosp />
		  <fu_window_end />
		  <next_fu_offset />
		  <next_fu_date />
		  <next_fu_snippet />
        </tmp>

	  </chw_fu>
	</instance>
	
	<bind nodeset="Meta/DeviceID" jr:preload="property" jr:preloadParams="DeviceID" />
    <bind nodeset="Meta/username" jr:preload="meta" jr:preloadParams="UserName" />
    <bind nodeset="Meta/chw_id" jr:preload="meta" jr:preloadParams="UserID" />
    <bind nodeset="Meta/TimeStart" type="dateTime" jr:preload="timestamp" jr:preloadParams="start" />
    <bind nodeset="Meta/TimeEnd" type="dateTime" jr:preload="timestamp" jr:preloadParams="end" />
	<bind nodeset="Meta/uid" type="xsd:string" jr:preload="uid" jr:preloadParams="general" />
		
	<bind nodeset="tmp/fu_window_end" calculate="/chw_fu/case_info/orig_visit_date + 42" />
	<bind nodeset="tmp/next_fu_offset" calculate="if(/chw_fu/no_meet/why_not = 'hospital', 14, 7)" />
	<bind nodeset="tmp/next_fu_date" calculate="today() + ../next_fu_offset" />
	<bind nodeset="tmp/next_fu_snippet" calculate="if(/chw_fu/no_meet/why_not = 'hospital', 'in two weeks', 'within one week')" />
		
	<bind nodeset="date" type="date" required="true()" jr:preload="date" jr:preloadParams="today" constraint=". &lt;= today() and . &gt;= (today() - 20)"/>
    <bind nodeset="info_be_on_time" relevant="../date != today()" />
    <bind nodeset="met_with_patient" required="true()" />

    <bind nodeset="met" relevant="../met_with_patient = 'y'" />
    <bind nodeset="no_meet" relevant="../met_with_patient = 'n'" />

    <bind nodeset="tmp/why_not_nohosp" required="true()" relevant="/chw_fu/case_info/followup_type != 'hospital'" />
    <bind nodeset="tmp/why_not_hosp" required="true()" relevant="/chw_fu/case_info/followup_type = 'hospital'" />
    <bind nodeset="no_meet/why_not" calculate="if(/chw_fu/case_info/followup_type = 'hospital', /chw_fu/tmp/why_not_hosp, /chw_fu/why_not_nohosp)" />

	<bind nodeset="no_meet/unresolved" relevant="../why_not != 'moved' and ../why_not != 'died'" />
	<bind nodeset="no_meet/unresolved/still_open" relevant="/chw_fu/date &lt; /chw_fu/tmp/fu_window_end" />
	<bind nodeset="no_meet/unresolved/info_lost_to_followup" relevant="/chw_fu/date &gt;= /chw_fu/tmp/fu_window_end" />

	<bind nodeset="no_meet/unresolved/still_open/attempt_again" required="true()" relevant="/chw_fu/no_meet/why_not = 'refused'" />
	<bind nodeset="no_meet/unresolved/still_open/again" relevant="/chw_fu/no_meet/why_not != 'refused' or ../attempt_again = 'y'" />
	<bind nodeset="no_meet/unresolved/still_open/again/when" relevant="/chw_fu/no_meet/why_not != 'hospital'" />

  </model>
</h:head>			
<h:body>

  <input ref="date">
    <label>When did you meet/attempt to meet the patient?</label>
  </input>

  <trigger ref="info_be_on_time">
    <label>Try to fill out the form the same day as the encounter</label>
  </trigger>

  <select1 ref="met_with_patient">
    <label>Were you able to meet with the patient?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <select1 ref="tmp/why_not_nohosp">
    <label>Why not?</label>
    <item><label>Patient moved away</label><value>moved</value></item>
    <item><label>Patient died</label><value>died</value></item>
    <item><label>Couldn't find patient</label><value>cant_find</value></item>
    <item><label>Patient unavailable</label><value>unavail</value></item>
    <item><label>Patient refused to meet</label><value>refused</value></item>
  </select1>

  <select1 ref="tmp/why_not_hosp">
    <label>Why not?</label>
    <item><label>Still at hospital</label><value>hospital</value></item>
    <item><label>Patient moved away</label><value>moved</value></item>
    <item><label>Patient died</label><value>died</value></item>
    <item><label>Couldn't find patient</label><value>cant_find</value></item>
    <item><label>Patient unavailable</label><value>unavail</value></item>
    <item><label>Patient refused to meet</label><value>refused</value></item>
  </select1>

  <select1 ref="no_meet/unresolved/still_open/attempt_again">
    <label>Will you attempt to meet with the patient again?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <trigger ref="no_meet/unresolved/still_open/again/info">
    <label>Attempt to meet with the patient again <output value="
      if(/chw_fu/tmp/next_fu_date &lt;= /chw_fu/tmp/fu_window_end,
        /chw_fu/tmp/next_fu_snippet,
        concat('by ', /chw_fu/tmp/fu_window_end))" /></label>
  </trigger>
  
  <input ref="no_meet/unresolved/still_open/again/when">
    <label>When will you next attempt to meet with the patient?</label>
  </input>

  <trigger ref="no_meet/unresolved/info_lost_to_followup">
    <label>It has been at least six weeks since this patient's original visit. They are now lost to follow-up. You do not need to attempt any more follow-ups for this patient.</label>
  </trigger>

</h:body>
</h:html>
