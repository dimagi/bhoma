<h:html xmlns="http://www.w3.org/2002/xforms"
        xmlns:h="http://www.w3.org/1999/xhtml"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:jr="http://openrosa.org/javarosa">
<h:head>
  <h:title>CHW Follow-up</h:title>
  <model>
  <instance>
    <chw_fu xmlns="http://cidrz.org/bhoma/chw_followup">
        
      <Meta>
        <DeviceID />
        <TimeStart />
        <TimeEnd />
        <username />
        <user_id />
        <uid />
        <version />
        
        <clinic_id />
      </Meta>
      
      <case>
        <patient_id />
        <case_id />
        <date_modified />
        <close />
        <update>
          <due_date />
          <bhoma_close />
          <bhoma_outcome />
        </update>
      </case>
      
      <case_info>
        <orig_visit_date />
        <followup_type />
        <missed_appt_date />
      </case_info>
      
      <date />
      <info_be_on_time />
      <met_with_patient />
      <met>
        <followup>
          <pregnancy>
            <still_pregnant />
            <info_go_to_clinic />
            <did_deliver />
            <lost_baby_when />
            <lost_baby_where />
            <illnesses />
            <delivered>
              <where_delivered />
              <term />
              <delivery_type />
              <complications />
              <complication_type />
              <fetal_mortality />
              <maternal_mortality />
              <postnatal_visit />
              <info_refer_to_clinic />
            </delivered>
          </pregnancy>
          <followup_outcome />
          <refer_back />
          <refer_when />
        </followup>
        <missed_appt>
          <why_missed />
          <went_when />
          <info_urge_to_go />
          <missed_apt_outcome />
          <will_they_go_back />
          <go_back_when />
        </missed_appt>
        <tmp>
          <going_back_to_clinic />
          <is_unresolved />
        </tmp>
        <return_appt_date />
      </met>
      <no_meet>
        <why_not />    
        <tmp>
          <is_unresolved />
        </tmp>
      </no_meet>
      <unresolved>
        <when_to_attempt_again />
        <info_lost_to_followup />
      </unresolved>
      <tmp>
        <pregnancy_outcome />
        <is_still_open />
        <fu_window_len_snippet />
        <fu_window_end />
        <next_fu_offset />
        <next_fu_date />
        <next_fu_snippet />
        <close_cc_case />
        <visit_date_raw />
        <missed_appt_date_raw />
      </tmp>
      
      <info_hack_done />
      
    </chw_fu>
  </instance>
  
  <bind nodeset="Meta/DeviceID" jr:preload="property" jr:preloadParams="DeviceID" />
  <bind nodeset="Meta/username" jr:preload="meta" jr:preloadParams="UserName" />
  <bind nodeset="Meta/user_id" jr:preload="meta" jr:preloadParams="UserID" />
  <bind nodeset="Meta/TimeStart" type="dateTime" jr:preload="timestamp" jr:preloadParams="start" />
  <bind nodeset="Meta/TimeEnd" type="dateTime" jr:preload="timestamp" jr:preloadParams="end" />
  <bind nodeset="Meta/uid" jr:preload="uid" jr:preloadParams="general" />
  <bind nodeset="Meta/version" jr:preload="meta" jr:preloadParams="AppVersion" />
  <bind nodeset="Meta/clinic_id" jr:preload="meta" jr:preloadParams="clinic_id" />
  
  <bind nodeset="case/case_id" jr:preload="case" jr:preloadParams="case-id" />
  <bind nodeset="case/date_modified" type="dateTime" jr:preload="timestamp" jr:preloadParams="end" />
  <bind nodeset="case/patient_id" jr:preload="case" jr:preloadParams="bhoma_patient_id" />
  
  <bind nodeset="case/close" relevant="/chw_fu/tmp/close_cc_case" />
  <bind nodeset="case/update/due_date" relevant="not(/chw_fu/tmp/close_cc_case)" calculate="/chw_fu/tmp/next_fu_date" />
  
  <bind nodeset="tmp/pregnancy_outcome" calculate="concat('gave_birth[',
    /chw_fu/met/followup/pregnancy/delivered/term, ';',
    /chw_fu/met/followup/pregnancy/delivered/delivery_type, ';',
    if(/chw_fu/met/followup/pregnancy/delivered/complications = 'y',
      concat('complications:', /chw_fu/met/followup/pregnancy/delivered/complication_type),
      'no_complications'
    ), ';',
    /chw_fu/met/followup/pregnancy/delivered/fetal_mortality, ';',
    /chw_fu/met/followup/pregnancy/delivered/maternal_mortality,
    ']')" />
  
  <bind nodeset="case/update/bhoma_outcome" calculate="
    if(/chw_fu/met/followup/pregnancy/still_pregnant = 'y', 'still_pregnant',
    if(/chw_fu/met/followup/pregnancy/did_deliver = 'n', 'patient_miscarriage',
    if(/chw_fu/met/followup/pregnancy/did_deliver = 'y', /chw_fu/tmp/pregnancy_outcome,
    if(/chw_fu/met/followup/followup_outcome = 'resolved', 'primary_diagnosis_resolved',
    if(/chw_fu/met/followup/followup_outcome = 'resolved_new_complaint', 'primary_diagnosis_resolved',
    if(/chw_fu/met/followup/refer_back = 'y', 'referred_back_to_clinic', 
    if(/chw_fu/met/missed_appt/why_missed = 'went', 'actually_went_to_clinic',
    if(/chw_fu/met/missed_appt/missed_apt_outcome = 'resolved', 'primary_diagnosis_resolved',
    if(/chw_fu/met/missed_appt/missed_apt_outcome = 'resolved_new_complaint', 'primary_diagnosis_resolved',
    if(/chw_fu/met/missed_appt/will_they_go_back = 'y', 'referred_back_to_clinic',
    if(/chw_fu/met/tmp/is_unresolved, 'met_no_return_no_outcome_yet',
    if(not(/chw_fu/no_meet/tmp/is_unresolved), /chw_fu/no_meet/why_not,
    if(not(/chw_fu/tmp/is_still_open), 'lost_to_followup_time_window',
      'pending_patient_meeting'
    )))))))))))))" />
  <bind nodeset="case/update/bhoma_close" calculate="
    if(/chw_fu/met/followup/pregnancy/still_pregnant = 'y', false(),
    if(/chw_fu/met/followup/pregnancy/did_deliver = 'n', true(),
    if(/chw_fu/met/followup/pregnancy/did_deliver = 'y', true(),
    if(/chw_fu/met/followup/followup_outcome = 'resolved', true(),
    if(/chw_fu/met/followup/followup_outcome = 'resolved_new_complaint', true(),
    if(/chw_fu/met/followup/refer_back = 'y', false(), 
    if(/chw_fu/met/missed_appt/why_missed = 'went', false(),
    if(/chw_fu/met/missed_appt/missed_apt_outcome = 'resolved', true(),
    if(/chw_fu/met/missed_appt/missed_apt_outcome = 'resolved_new_complaint', true(),
    if(/chw_fu/met/missed_appt/will_they_go_back = 'y', false(),
    if(/chw_fu/met/tmp/is_unresolved, false(),
    if(not(/chw_fu/no_meet/tmp/is_unresolved), true(),
    if(not(/chw_fu/tmp/is_still_open), true(),
      false()
    )))))))))))))" />
  <bind nodeset="tmp/close_cc_case" calculate="not(/chw_fu/met/tmp/is_unresolved or /chw_fu/no_meet/tmp/is_unresolved) or not(/chw_fu/tmp/is_still_open)" />
  
  <bind nodeset="tmp/visit_date_raw" jr:preload="case" jr:preloadParams="orig_visit_date" />
  <bind nodeset="tmp/missed_appt_date_raw" jr:preload="case" jr:preloadParams="missed_appt_date" />
  <bind nodeset="case_info/orig_visit_date" calculate="date(/chw_fu/tmp/visit_date_raw)" />
  <bind nodeset="case_info/missed_appt_date" calculate="date(/chw_fu/tmp/missed_appt_date_raw)" />
  <bind nodeset="case_info/followup_type" jr:preload="case" jr:preloadParams="followup_type" />
  
  <bind nodeset="tmp/fu_window_end" calculate="date(
    if(/chw_fu/case_info/followup_type != 'pregnancy',
      /chw_fu/case_info/orig_visit_date + 7 * 6,
      /chw_fu/case_info/missed_appt_date + 7 * 4
    ))" />
  <bind nodeset="tmp/next_fu_offset" calculate="if(/chw_fu/no_meet/why_not = 'hospital', 14, 7)" />
  <bind nodeset="tmp/next_fu_date" calculate="date(today() + ../next_fu_offset)" />
  <bind nodeset="tmp/next_fu_snippet" calculate="if(/chw_fu/no_meet/why_not = 'hospital', 'in two weeks', 'within one week')" />
  <bind nodeset="tmp/fu_window_len_snippet" calculate="if(/chw_fu/case_info/followup_type != 'pregnancy', 'six weeks', 'four weeks')" />
  
  <bind nodeset="date" type="date" required="true()" jr:preload="date" jr:preloadParams="today" constraint=". &lt;= today() and . &gt;= (today() - 20)"/>
  <bind nodeset="info_be_on_time" relevant="../date != today()" />
  <bind nodeset="met_with_patient" required="true()" />
  
  <bind nodeset="met" relevant="../met_with_patient = 'y'" />
  <bind nodeset="no_meet" relevant="../met_with_patient = 'n'" />
  
  <bind nodeset="met/followup" relevant="/chw_fu/case_info/followup_type != 'missed_appt'" />
  <bind nodeset="met/missed_appt" relevant="/chw_fu/case_info/followup_type = 'missed_appt'" />
  <bind nodeset="met/followup/pregnancy" relevant="/chw_fu/case_info/followup_type = 'pregnancy'" />
  
  <bind nodeset="met/followup/pregnancy/still_pregnant" required="true()" />
  <bind nodeset="met/followup/pregnancy/info_go_to_clinic" relevant="../still_pregnant = 'y'" />
  <bind nodeset="met/followup/pregnancy/did_deliver" required="true()" relevant="../still_pregnant = 'n'" />
  <bind nodeset="met/followup/pregnancy/lost_baby_when" type="decimal" relevant="../did_deliver = 'n'" constraint=". &lt; 12" jr:constraintMsg="Gestation Age should be less than 12 months" />
  <bind nodeset="met/followup/pregnancy/lost_baby_where" relevant="../did_deliver = 'n'" />
  <bind nodeset="met/followup/pregnancy/illnesses" required="true()" relevant="../still_pregnant = 'n'" />
  <bind nodeset="met/followup/pregnancy/delivered" relevant="../did_deliver = 'y'" />
  <bind nodeset="met/followup/pregnancy/delivered/term" required="true()" />
  <bind nodeset="met/followup/pregnancy/delivered/delivery_type" required="true()" />
  <bind nodeset="met/followup/pregnancy/delivered/complications" required="true()" />
  <bind nodeset="met/followup/pregnancy/delivered/complication_type" required="true()" relevant="../complications = 'y'" />
  <bind nodeset="met/followup/pregnancy/delivered/fetal_mortality" required="true()" />
  <bind nodeset="met/followup/pregnancy/delivered/maternal_mortality" required="true()" />
  <bind nodeset="met/followup/pregnancy/delivered/postnatal_visit" required="true()" relevant="../maternal_mortality = 'mother_alive'" />
  <bind nodeset="met/followup/pregnancy/delivered/info_refer_to_clinic" relevant="../postnatal_visit = 'n'" />
  <bind nodeset="met/followup/followup_outcome" required="true()" relevant="/chw_fu/case_info/followup_type != 'pregnancy'" />
  <bind nodeset="met/followup/refer_back" required="true()" relevant="../followup_outcome != 'resolved' and (/chw_fu/met/followup/pregnancy/delivered/postnatal_visit = 'n' or /chw_fu/met/followup/pregnancy/still_pregnant != 'n')" />
  <bind nodeset="met/followup/refer_when" type="date" required="true()" relevant="../refer_back = 'y'" />
  <bind nodeset="met/missed_appt/why_missed" required="true()" />
  <bind nodeset="met/missed_appt/went_when" type="date" relevant="../why_missed = 'went'" />
  <bind nodeset="met/missed_appt/info_urge_to_go" relevant="../why_missed != 'went' and ../why_missed != 'feeling_better'" />
  <bind nodeset="met/missed_appt/missed_apt_outcome" required="true()" relevant="../why_missed != 'went'"/>
  <bind nodeset="met/missed_appt/will_they_go_back" required="true()" relevant="../missed_apt_outcome != 'resolved' and ../why_missed != 'went'" />
  <bind nodeset="met/missed_appt/go_back_when" type="date" required="true()" relevant="../will_they_go_back = 'y'" />
  <bind nodeset="met/return_appt_date" calculate="if(../followup/refer_when, ../followup/refer_when, ../missed_appt/go_back_when)" />
  
  <bind nodeset="met/tmp/going_back_to_clinic" calculate="/chw_fu/met/followup/refer_back = 'y' or /chw_fu/met/missed_appt/will_they_go_back = 'y'" />
  <bind nodeset="met/tmp/is_unresolved" calculate="
    /chw_fu/met/followup/pregnancy/still_pregnant = 'y' or (
      not(/chw_fu/met/tmp/going_back_to_clinic) and (
        /chw_fu/met/followup/followup_outcome = 'not_resolved' or
        /chw_fu/met/missed_appt/missed_apt_outcome = 'not_resolved'
      )
    )" />
  
  <bind nodeset="no_meet/why_not" required="true()" />
  <bind nodeset="no_meet/tmp/is_unresolved" calculate="/chw_fu/no_meet/why_not != 'moved' and /chw_fu/no_meet/why_not != 'died' and /chw_fu/no_meet/why_not != 'refused' and /chw_fu/no_meet/why_not != 'outside_catchment_area'" />
  
  <bind nodeset="unresolved" relevant="/chw_fu/met/tmp/is_unresolved or /chw_fu/no_meet/tmp/is_unresolved" />
  <bind nodeset="tmp/is_still_open" calculate="/chw_fu/date &lt; /chw_fu/tmp/fu_window_end" />  
  <bind nodeset="unresolved/when_to_attempt_again" relevant="/chw_fu/tmp/is_still_open" />
  <bind nodeset="unresolved/info_lost_to_followup" relevant="not(/chw_fu/tmp/is_still_open)" />
  
  </model>
</h:head>      
<h:body>

  <input ref="date">
    <label>When did you meet / attempt to meet the patient?</label>
  </input>

  <trigger ref="info_be_on_time">
    <label>Try to fill out the form the same day as the encounter</label>
  </trigger>

  <select1 ref="met_with_patient">
    <label>Were you able to meet with the patient?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <select1 ref="met/followup/pregnancy/still_pregnant">
    <label>Is the patient still pregnant?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>
  
  <trigger ref="met/followup/pregnancy/info_go_to_clinic">
    <label>Urge the patient to go to the clinic to deliver!</label>
  </trigger>
  
  <select1 ref="met/followup/pregnancy/did_deliver">
    <label>Did the patient's pregnancy result in delivery?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No, patient miscarried</label><value>n</value></item>
  </select1>

  <input ref="met/followup/pregnancy/lost_baby_when">
    <label>How long ago was the baby lost (in months)?</label>
  </input>

  <select1 ref="met/followup/pregnancy/lost_baby_where">
    <label>Where was the baby lost?</label>
    <item><label>Home</label><value>home</value></item>
    <item><label>Clinic</label><value>clinic</value></item>
    <item><label>Hospital</label><value>hospital</value></item>
    <item><label>Other</label><value>other</value></item>
  </select1>
  
  <select1 ref="met/followup/pregnancy/illnesses">
    <label>Did the patient have any illnesses during the pregnancy?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <select1 ref="met/followup/pregnancy/delivered/where_delivered">
    <label>Where did the mother deliver?</label>
    <item><label>At home, assisted by TBA</label><value>home_assisted</value></item>
    <item><label>At home, unassisted</label><value>home_unassisted</value></item>
    <item><label>Clinic</label><value>clinic</value></item>
    <item><label>Hospital</label><value>hospital</value></item>
    <item><label>Other</label><value>other</value></item>
  </select1>

  <select1 ref="met/followup/pregnancy/delivered/term">
    <label>Please describe the delivery:</label>
    <item><label>Term</label><value>term</value></item>
    <item><label>Pre-Term</label><value>preterm</value></item>
  </select1>
  
  <select1 ref="met/followup/pregnancy/delivered/delivery_type">
    <label>Please describe the type of delivery:</label>
    <item><label>Spontaneous Vaginal (head first)</label><value>svd</value></item>
    <item><label>Cesarean</label><value>cesarean</value></item>
    <item><label>Breech (assisted/extracted)</label><value>breech</value></item>
    <item><label>Vacuum</label><value>vacuum</value></item>
    <item><label>Forceps</label><value>forceps</value></item>
  </select1>

  <select1 ref="met/followup/pregnancy/delivered/complications">
    <label>Were there complications?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <select ref="met/followup/pregnancy/delivered/complication_type">
    <label>What type of complications occurred?</label>
    <item><label>Hypertensive Disorders</label><value>hypertensive</value></item>
    <item><label>Hemorrhage</label><value>hemorrhage</value></item>
    <item><label>Prolonged Labor</label><value>prolonged_labor</value></item>
    <item><label>Premature Rupture of Membranes</label><value>prom</value></item>
    <item><label>Intrapartum Infection</label><value>infection</value></item>
    <item><label>Other</label><value>other</value></item>
  </select>
  
  <select1 ref="met/followup/pregnancy/delivered/fetal_mortality">
    <label>Is the baby alive?</label>
    <item><label>Yes</label><value>baby_alive</value></item>
    <item><label>No, baby dead at birth</label><value>fetal_death</value></item>
    <item><label>No, born alive, but died within one week</label><value>perinatal_death</value></item>
  </select1>

  <select1 ref="met/followup/pregnancy/delivered/maternal_mortality">
    <label>Is the mother alive?</label>
    <item><label>Yes</label><value>mother_alive</value></item>
    <item><label>No</label><value>maternal_death</value></item>
  </select1>

  <select1 ref="met/followup/pregnancy/delivered/postnatal_visit">
    <label>Has the mother been back to the clinic for her postnatal / followup visit?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>
  
  <trigger ref="met/followup/pregnancy/delivered/info_refer_to_clinic">
    <label>Urge the mother to go to the clinic for a postnatal/followup visit.</label>
  </trigger>
  
  <select1 ref="met/followup/followup_outcome">
    <label>Select the Patient Outcome</label>
    <item><label>Patient feeling better, primary complaint resolved</label><value>resolved</value></item>
    <item><label>Patient still sick from primary complaint</label><value>not_resolved</value></item>
    <item><label>Primary complaint resolved, but patient has other complaints</label><value>resolved_new_complaint</value></item>
   </select1>
 
  <select1 ref="met/followup/refer_back">
    <label>Will the patient return to the clinic?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>
  
  <input ref="met/followup/refer_when">
    <label>When will the patient return to the clinic?</label>
  </input>

  <select1 ref="met/missed_appt/why_missed">
    <label>Why did the patient miss their appointment?</label>
    <item><label>Patient did go</label><value>went</value></item>
    <item><label>Feeling better</label><value>feeling_better</value></item>
    <item><label>Too far</label><value>too_far</value></item>
    <item><label>Too expensive</label><value>too_pricey</value></item>
    <item><label>No time</label><value>no_time</value></item>
    <item><label>Refused to go</label><value>refused_to_go</value></item>
    <item><label>Other</label><value>other</value></item>
  </select1>

  <input ref="met/missed_appt/went_when">
    <label>When did the patient go?</label>
  </input>

  <trigger ref="met/missed_appt/info_urge_to_go">
    <label>Remind the patient not to miss appointments.  Urge the patient to return to the clinic.</label>
  </trigger>

  <select1 ref="met/missed_appt/missed_apt_outcome">
    <label>Select the Patient Outcome</label>
    <item><label>Patient feeling better, primary complaint resolved</label><value>resolved</value></item>
    <item><label>Patient still sick from primary complaint</label><value>not_resolved</value></item>
    <item><label>Primary complaint resolved, but patient has other complaints</label><value>resolved_new_complaint</value></item>
  </select1>
  
  <select1 ref="met/missed_appt/will_they_go_back">
    <label>Will the patient return to the clinic?</label>
    <item><label>Yes</label><value>y</value></item>
    <item><label>No</label><value>n</value></item>
  </select1>

  <input ref="met/missed_appt/go_back_when">
    <label>What day will the patient go back to the clinic?</label>
  </input>
 
  <select1 ref="no_meet/why_not">
    <label>Why were you unable to meet?</label>
    <item><label>Patient in hospital</label><value>hospital</value></item>
    <item><label>Patient moved away</label><value>moved</value></item>
    <item><label>Patient died</label><value>died</value></item>
    <item><label>Couldn't find patient</label><value>cant_find</value></item>
    <item><label>Patient unavailable</label><value>unavail</value></item>
    <item><label>Patient refused to meet</label><value>refused</value></item>
    <item><label>Patient doesn't live in catchment area</label><value>outside_catchment_area</value></item>
    <item><label>Other</label><value>other</value></item>
  </select1>

  <trigger ref="unresolved/when_to_attempt_again">
    <label>Attempt to meet with the patient again <output value="
      if(/chw_fu/tmp/next_fu_date &lt;= /chw_fu/tmp/fu_window_end,
        /chw_fu/tmp/next_fu_snippet,
        concat('by ', format-date(/chw_fu/tmp/fu_window_end, '%e/%n')))" /></label>
  </trigger>

  <trigger ref="unresolved/info_lost_to_followup">
    <label>It has been at least <output value="/chw_fu/tmp/fu_window_len_snippet" /> since this patient's original visit. They are now lost to follow-up. You do not need to attempt any more follow-ups for this patient.</label>
  </trigger>

  <trigger ref="info_hack_done">
    <label>Thank you. The follow-up form is complete.</label>
  </trigger>

</h:body>
</h:html>
