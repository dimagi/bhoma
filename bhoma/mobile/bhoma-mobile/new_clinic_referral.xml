<h:html xmlns="http://www.w3.org/2002/xforms"
        xmlns:h="http://www.w3.org/1999/xhtml"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:jr="http://openrosa.org/javarosa">
<h:head>
  <h:title>New Referral to Clinic</h:title>
  <model>
	<instance>
	  <clinic_refer xmlns="http://cidrz.org/bhoma/new_clinic_referral">
        
        <Meta>
            <DeviceID />
            <TimeStart />
            <TimeEnd />
            <username />
            <user_id />
            <uid />
            <version />
            
            <clinic_id />
        </Meta>
        
        <has_patient_id />
        <patient_id />
        
		<fname />
		<lname />
		<sex />
		<dob />
		<dob_est />
		<village />
		<contact />

		<life_threatening />
		<complaint />
		
		<chw_referral_id />
		<info_ref_id />
		
		<appt_date />
		
		<info_done />
		
	  </clinic_refer>
	</instance>
	
	<bind nodeset="Meta/DeviceID" jr:preload="property" jr:preloadParams="DeviceID" />
    <bind nodeset="Meta/username" jr:preload="meta" jr:preloadParams="UserName" />
    <bind nodeset="Meta/user_id" jr:preload="meta" jr:preloadParams="UserID" />
    <bind nodeset="Meta/TimeStart" type="dateTime" jr:preload="timestamp" jr:preloadParams="start" />
    <bind nodeset="Meta/TimeEnd" type="dateTime" jr:preload="timestamp" jr:preloadParams="end" />
	<bind nodeset="Meta/uid" type="xsd:string" jr:preload="uid" jr:preloadParams="general" />
	<bind nodeset="Meta/version" jr:preload="meta" jr:preloadParams="AppVersion" />
    <bind nodeset="Meta/clinic_id" jr:preload="meta" jr:preloadParams="clinic_id" />

	<bind nodeset="has_patient_id" required="true()" />
	<bind nodeset="patient_id" required="true()" type="float" relevant="../has_patient_id = 'y'" constraint=". &gt;= 501000000000 and . &lt; 504000000000" jr:constraintMsg="A BHOMA patient ID must have 12 digits, starting with 501, 502, or 503" /> <!-- numeric field -->
		
	<bind nodeset="fname" required="true()" />
	<bind nodeset="lname" required="true()" />
	<bind nodeset="sex" required="true()" relevant="../has_patient_id = 'n'" />
	<bind nodeset="dob" type="date" required="true()" relevant="../has_patient_id = 'n'" constraint=". &lt;= today()" jr:constraintMsg="birthdate must be in past" />
	<bind nodeset="dob_est" required="true()" relevant="../has_patient_id = 'n'" />
	<bind nodeset="village" required="true()" relevant="../has_patient_id = 'n'" />
	<bind nodeset="contact" type="float" relevant="../has_patient_id = 'n'" /> <!-- numeric field -->
	
	<bind nodeset="life_threatening" required="true()" />

	<bind nodeset="chw_referral_id" calculate="chw-referral-num()" />
	<bind nodeset="appt_date" type="date" required="true()" constraint=". &gt;= today() and . &lt;= (today() + 42)" jr:constraintMsg="must be within the next 6 weeks" />

  </model>
  
</h:head>			
<h:body>

  <select1 ref="has_patient_id">
  	<label>Does the patient have a BHOMA Patient ID?</label>
  	<item><label>Yes</label><value>y</value></item>
  	<item><label>No</label><value>n</value></item>
  </select1>

  <input ref="patient_id">
  	<label>Enter BHOMA Patient ID #</label>
  </input>

  <input ref="fname">
  	<label>First Name</label>
  </input>

  <input ref="lname">
  	<label>Last Name</label>
  </input>

  <select1 ref="sex">
  	<label>Sex</label>
  	<item><label>Male</label><value>m</value></item>
  	<item><label>Female</label><value>f</value></item>
  </select1>  

  <input ref="dob">
  	<label>Date of Birth</label>
  </input>

  <select1 ref="dob_est">
  	<label>Is date of birth estimated?</label>
  	<item><label>No</label><value>n</value></item>
  	<item><label>Yes</label><value>y</value></item>
  </select1>  

  <input ref="village">
  	<label>Village</label>
  </input>
  
  <input ref="contact">
  	<label>Phone # to be reached at, if any</label>
  </input>

  <select ref="complaint">
    <label>What is the patient's health problem?</label>
	<item><label>Diarrhea</label><value>diarrhea</value></item>
	<item><label>Vomiting</label><value>vomiting</value></item>
	<item><label>HIV / AIDS</label><value>hiv_aids</value></item>
	<item><label>Measles</label><value>measles</value></item>
	<item><label>Malaria</label><value>malaria</value></item>
	<item><label>Cough / RTI</label><value>cough_rti</value></item>
	<item><label>Injury</label><value>injury</value></item>
	<item><label>Fever</label><value>fever</value></item>
	<item><label>Fatigue</label><value>fatigue</value></item>
	<item><label>Headache</label><value>headache</value></item>
	<item><label>Recent Stroke</label><value>stroke</value></item>
	<item><label>Malnutrition</label><value>malnutrition</value></item>
	<item><label>Infection</label><value>infection</value></item>
	<item><label>They don't know</label><value>they_dont_know</value></item>
	<item><label>Other</label><value>other</value></item>
  </select>

  <select1 ref="life_threatening">
  	<label>Is patient's issue life-threatening?</label>
  	<item><label>No</label><value>n</value></item>
  	<item><label>Yes</label><value>y</value></item>
  </select1>  
  
  <trigger ref="info_ref_id">
  	<label>The referral code is: <output value="../chw_referral_id" />. Give this number to the patient to bring with them to the clinic.</label>
  </trigger>

  <input ref="appt_date">
  	<label>What day does the patient expect to go to the clinic?</label>
  </input>

  <trigger ref="info_done">
  	<label>This patient has been referred. The clinic will expect them on or around the given appointment date.</label>
  </trigger>

</h:body>
</h:html>
