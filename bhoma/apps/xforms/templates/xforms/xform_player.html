<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="{{MEDIA_URL}}webapp/javascripts/jquery-1.4.2.min.js"></script>

<script language="javascript">

XFORM_URL = "{% url xform_player_proxy %}"

gSessionID = -1;

function $(elementID) {
  return document.getElementById(elementID);
}

function removeAllChildren (element) {
  while (element.hasChildNodes()) {
    element.removeChild(element.firstChild);
  }
}

function init () {
  $("start").style.display = 'table-cell';
  $("question").style.display = 'none';
  $("done").style.display = 'none';
}

function loadForm (formName) {
  $("start").style.display = 'none';
  $("question").style.display = 'block';
  $("done").style.display = 'none';
  jQuery.post(XFORM_URL, 
              JSON.stringify({'action': 'new-form', 
                              'form-name': formName,
                              'preloader-data': {{ preloader_data|safe }} }), 
              function (resp) { gSessionID = resp["session_id"];
                                renderEvent(resp["event"], true);
                              }, "json");
}

function renderEvent (event, dirForward) {
  if (event["type"] == "question") {
    renderQuestion(event);
  } else if (event["type"] == "form-complete") {
    formComplete(event);
  } else if (event["type"] == "sub-group") {
    if (event["repeatable"]) {
      alert("i can't support repeats right now!");
    }
  
    jQuery.post(XFORM_URL, JSON.stringify({'action': (dirForward ? 'next' : 'back'), 'session-id': gSessionID}), function (resp) {
      renderEvent(resp["event"], dirForward || resp["at-start"]);
    }, "json");
  } else {
    alert("unrecognized event [" + event["type"] + "]");
  }
}

function renderQuestion (event) {
  $("caption").textContent = event["caption"];
  $("val-error").style.display = "none";
 
  removeAllChildren($("control"));
  $("control").setAttribute("datatype", event["datatype"]);
  if (event["datatype"] == "str" ||
      event["datatype"] == "int" ||
      event["datatype"] == "float" ||
      event["datatype"] == "date") {
    input = document.createElement("input");
    input.id = "freetext";
    
    if (event["answer"] != null) {
      input.value = event["answer"];
    }
    
    $("control").appendChild(input);
  } else if (event["datatype"] == "select" || event["datatype"] == "multiselect") {
    for (i = 0; i < event["choices"].length; i++) {
      ord = i + 1;
    
      caption = document.createElement("span");
      caption.textContent = event["choices"][i] + "   ";
    
      input = document.createElement("input");
      input.type = (event["datatype"] == "select" ? "radio" : "checkbox");
      input.name = "select";
      input.value = ord;
      if (event["answer"] != null) {
        input.checked = (event["datatype"] == "select" ? ord == event["answer"] : event["answer"].indexOf(ord) != -1);
      }
        
      $("control").appendChild(caption);
      $("control").appendChild(input);
      $("control").appendChild(document.createElement("br"));
    }
  } else if (event["datatype"] == "info") {
    //do nothing - caption only
  } else {
    alert("unrecognized datatype [" + event["datatype"] + "]");
  }
}

function getQuestionAnswer () {
  type = $("control").getAttribute("datatype");
  if (type == "str" || type == "int" || type == "float" || type == "date") {
    return $("freetext").value;
  } else if (type == "select" || type == "multiselect") {
    answer = [];
    choices = document.getElementsByName("select");
    for (i = 0; i < choices.length; i++) {
      choice = choices[i];
      if (choice.checked) {
        answer.push(choice.value);
      }
    }
    
    if (type == "select") {
      return answer.length > 0 ? answer[0] : null;
    } else {
      return answer;
    }
  } else if (type == "info") {
    return null;
  }
}

function answerQuestion () {
  answer = getQuestionAnswer();
  
  jQuery.post(XFORM_URL, JSON.stringify({'action': 'answer', 'session-id': gSessionID, 'answer': answer}), function (resp) {
    if (resp["status"] == "validation-error") {
      if (resp["type"] == "required") {
        $("val-error").textContent = "An answer is required";
      } else if (resp["type"] == "constraint") {
        $("val-error").textContent = resp["reason"];      
      }
      $("val-error").style.display = "block";
    } else {
      renderEvent(resp["event"], true);
    }
  }, "json");
}

function prevQuestion () {
  jQuery.post(XFORM_URL, JSON.stringify({'action': 'back', 'session-id': gSessionID}), function (resp) {
    renderEvent(resp["event"], false);
  }, "json");
}

function post_to_url(path, params, method) {
    // hat tip: http://stackoverflow.com/questions/133925/javascript-post-request-like-a-form-submit
    method = method || "post"; // Set method to post by default, if not specified.
    // The rest of this code assumes you are not using a library.
    // It can be made less wordy if you use one.
    
    var form = document.createElement("form");
    form.setAttribute("method", method);
    form.setAttribute("action", path);

    for(var key in params) {
        var hiddenField = document.createElement("input");
        hiddenField.setAttribute("type", "hidden");
        hiddenField.setAttribute("name", key);
        hiddenField.setAttribute("value", params[key]);

        form.appendChild(hiddenField);
    }

    form.submit();
}
function formComplete (event) {
    // POST the response back to ourselves for further processing
    post_to_url("", event)
}

</script>
    
  </head>
  <body onLoad="init()" style="font-family: sans-serif; font-size: x-large;">  
    <div id="canvas" style="width: 1004px; height: 748px; background-color: #bde; border-style: solid; border-width: 10px;">
    <div id="inside" style="margin: 30px; display: table; width: 100%; height: 100%">
  
    <div id="start" style="vertical-align: middle; text-align: center">
      <button onClick="loadForm(document.getElementById('formname').value)" style="width: 200px; height: 100px; font-size: xx-large; font-weight: bold">START</button><br>
      Form: {{xform.name}}<input id="formname" value="{{xform.file.path}}" type="hidden"></input>
    </div>
  
    <div id="question" style="height: 100%; width: 100%;">
      <div id="caption" style="text-align: left; vertical-align: top;"></div>
      <p id="val-error" style="background-color: red;"></p>
      <div id="control">
      
      </div>
      <div style="text-align: left; vertical-align: bottom; display: table-cell;">
      <button onClick="prevQuestion();" style="height: 50px; width: 75px;">BACK</button>
      </div>
      <div style="text-align: right; vertical-align: bottom; display: table-cell;">
      <button onClick="answerQuestion();" style="height: 50px; width: 75px;">NEXT</button>
      </div>
    </div>
  
    <div id="done">
      <p>The form is finished. It has been saved as instance <span id="save-inst"></span>. Here is the form output:</p>
      <code id="form-xml"></code>
    </div>
  
    </div>
    </div>
  </body>
</html>

